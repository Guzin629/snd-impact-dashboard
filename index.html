<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SND Impact Dashboard – Tango & Frida</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator.min.css" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff;
      --surface:#ffffff;
      --surface-2:#f6f8fb;
      --border:rgba(15,23,42,.12);
      --shadow:0 10px 28px rgba(15,23,42,.10);
      --text:#0b1f33;
      --muted:#526173;
      --blue:#0B6FB8;
      --blue-2:#66A3D2;
      --blue-3:#0e2b63;
    }
    body{ background:var(--bg); color:var(--text); }
    .card{ background:var(--surface); border:1px solid var(--border); box-shadow:var(--shadow); }
    .muted{ color:var(--muted) !important; }
    .pill{ font-size:.82rem; padding:.2rem .55rem; border-radius:999px; background:var(--surface-2); border:1px solid var(--border); color:var(--text); }
    .kpi{ font-size:1.7rem; font-weight:750; line-height:1; color:var(--blue-3); }
    .kpi-label{ font-size:.85rem; color:var(--muted); }

    .nav-pills .nav-link{ color:var(--blue-3); background:transparent; }
    .nav-pills .nav-link:hover{ background:var(--surface-2); }
    .nav-pills .nav-link.active{ background:var(--blue); color:#fff; }

    .form-select, .form-control{ background:#fff !important; color:var(--text) !important; border-color:var(--border) !important; }

    .tabulator{ background:transparent; color:var(--text); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .tabulator .tabulator-header{ background:var(--surface-2); color:var(--text); border-bottom:1px solid var(--border); }
    .tabulator-row{ background:#fff; border-bottom:1px solid rgba(15,23,42,.08); }
    .tabulator-row.tabulator-row-even{ background:var(--surface-2); }
    .tabulator .tabulator-cell{ border-right:1px solid rgba(15,23,42,.06); }
  </style>
</head>
<body>
  <div class="container-fluid px-4 py-4">
    <div class="d-flex flex-wrap align-items-end justify-content-between mb-3">
      <div>
        <h2 class="mb-1">SND Impact Dashboard</h2>
        <div class="muted">Projects: <span class="pill">Tango</span> <span class="pill">Frida</span> • Interactive view of Step #1–#4 (no deltas)</div>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <label class="muted">Metric</label>
        <select id="metricSelect" class="form-select form-select-sm" style="width:210px;">
          <option value="ImpactWeights" selected>Impact (weights)</option>
          <option value="ImpactCount">Impact (count)</option>
        </select>
      </div>
    </div>

    <ul class="nav nav-pills mb-3" role="tablist">
      <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#step1" type="button">Step #1 – Profile</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#step2" type="button">Step #2 – Compare</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#step3" type="button">Step #3 – Question Map</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#step4" type="button">Step #4 – Bottlenecks</button></li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="step1">
        <div class="row g-3">
          <div class="col-xl-3">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <div class="muted">Project</div>
                  <select id="projectSelect" class="form-select form-select-sm"></select>
                </div>
                <div class="text-end">
                  <div class="muted">Total impact</div>
                  <div id="kpiTotal" class="kpi">–</div>
                </div>
              </div>
              <div class="row g-2">
                <div class="col-6"><div class="card p-2" style="box-shadow:none"><div class="kpi-label">Yes</div><div id="kpiYes" class="kpi" style="font-size:1.35rem">–</div></div></div>
                <div class="col-6"><div class="card p-2" style="box-shadow:none"><div class="kpi-label">Responses</div><div id="kpiResp" class="kpi" style="font-size:1.35rem">–</div></div></div>
              </div>
              <div class="mt-3 muted" style="font-size:.9rem">Radar shows relative impact across the five pillars using the selected metric.</div>
            </div>
          </div>
          <div class="col-xl-9"><div class="card p-3"><div id="radar" style="height:420px"></div></div></div>
        </div>
      </div>

      <div class="tab-pane fade" id="step2">
        <div class="row g-3">
          <div class="col-xl-3"><div class="card p-3"><div class="muted mb-2">Compare projects</div><div id="projectChecks" class="d-flex flex-column gap-1"></div></div></div>
          <div class="col-xl-9"><div class="card p-3"><div id="compareBar" style="height:460px"></div></div></div>
        </div>
      </div>

      <div class="tab-pane fade" id="step3">
        <div class="row g-3">
          <div class="col-xl-3"><div class="card p-3">
            <div class="muted">Filters</div>
            <div class="mt-2"><label class="muted" style="font-size:.85rem">Section</label>
              <select id="sectionFilter" class="form-select form-select-sm"></select>
            </div>
            <div class="mt-2"><label class="muted" style="font-size:.85rem">Search question text</label>
              <input id="searchBox" class="form-control form-control-sm" placeholder="e.g. warehousing" />
            </div>
            <div class="mt-3 muted" style="font-size:.9rem">Heatmap uses a blue scale: lighter = lower, darker = higher.</div>
          </div></div>
          <div class="col-xl-9"><div class="card p-3"><div id="heatmap" style="height:420px"></div></div></div>
          <div class="col-12"><div class="card p-3"><div class="d-flex justify-content-between align-items-center"><div><h5 class="mb-0">Question details</h5><div class="muted" style="font-size:.9rem">Sortable table. Weight shown for context.</div></div><div class="muted" id="tableCount"></div></div><div id="qTable" class="mt-2"></div></div></div>
        </div>
      </div>

      <div class="tab-pane fade" id="step4">
        <div class="row g-3">
          <div class="col-xl-6"><div class="card p-3"><h5 class="mb-1">Portfolio hotspots (computed)</h5><div id="hotspotTable" class="mt-2"></div></div></div>
          <div class="col-xl-6"><div class="card p-3"><h5 class="mb-1">Known bottlenecks (from workbook)</h5><div id="bottleneckTable" class="mt-2"></div></div></div>
        </div>
      </div>
    </div>

    <div class="mt-4 muted" style="font-size:.85rem">Data source: <b>SND Impact CMA focus v3.xlsx</b> (Tango & Frida tabs + Bottlenecks). No deltas are computed.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
<script>
const STEP12 = {"projects": ["Tango", "Frida"], "sections": ["SNO", "Leaf", "Procurement", "Factory", "EM SC"], "impacts": {"Tango": {"SNO": {"ImpactWeights": 0.5369127516778524, "ImpactCount": 0.5714285714285714, "Yes": 8, "No": 6, "Responses": 14}, "Leaf": {"ImpactWeights": 0.0, "ImpactCount": 0.0, "Yes": 0, "No": 1, "Responses": 1}, "Procurement": {"ImpactWeights": 0.0, "ImpactCount": 0.0, "Yes": 0, "No": 6, "Responses": 6}, "Factory": {"ImpactWeights": 0.553941908713693, "ImpactCount": 0.5454545454545454, "Yes": 6, "No": 5, "Responses": 11}, "EM SC": {"ImpactWeights": 0.47923875432525953, "ImpactCount": 0.5, "Yes": 7, "No": 7, "Responses": 14}, "Cumulative": {"ImpactWeights": 0.43947100712105797, "ImpactCount": 0.45652173913043476, "Yes": 21, "No": 25, "Responses": 1}}, "Frida": {"SNO": {"ImpactWeights": 0.5620805369127517, "ImpactCount": 0.5714285714285714, "Yes": 8, "No": 6, "Responses": 14}, "Leaf": {"ImpactWeights": 0.0, "ImpactCount": 0.0, "Yes": 0, "No": 1, "Responses": 1}, "Procurement": {"ImpactWeights": 0.0, "ImpactCount": 0.0, "Yes": 0, "No": 6, "Responses": 6}, "Factory": {"ImpactWeights": 0.5020746887966805, "ImpactCount": 0.45454545454545453, "Yes": 5, "No": 6, "Responses": 11}, "EM SC": {"ImpactWeights": 0.3719723183391003, "ImpactCount": 0.35714285714285715, "Yes": 5, "No": 9, "Responses": 14}, "Cumulative": {"ImpactWeights": 0.40284842319430314, "ImpactCount": 0.391304347826087, "Yes": 18, "No": 28, "Responses": 1}}}};
const STEP3 = {"questionMeta": [{"Q": 1, "Section": "SNO", "Question": "Will the filter supplier change?", "Notes": "Answer \"no\" if the current source will continue to supply. ", "Weight": 0.96875, "ShowStopper": "No"}, {"Q": 2, "Section": "SNO", "Question": "Will there be a need to supply base rods from a different site?", "Notes": "Answer \"yes\" if the filter combining plant will need base rods from a different site due to capacity or capability constraints.", "Weight": 1.15625, "ShowStopper": "No"}, {"Q": 3, "Section": "SNO", "Question": "Will the blend supplier change?", "Notes": "Answer \"no\" if the current source will continue to supply. ", "Weight": 0.96875, "ShowStopper": "No"}, {"Q": 4, "Section": "SNO", "Question": "Will the source of blend ingredients change by this initiative (Diet, Fibex, Stem)?", "Notes": "Answer taking into account \n- volume;\n- regulatory compliance requirements;\n- specific requirements (e.g. shipping case dimensions);\n- import duties.\nDoes not apply to MO. ", "Weight": 1.25, "ShowStopper": "No"}, {"Q": 5, "Section": "SNO", "Question": "Will the initiative introduce a change in CSP?", "Notes": "nan", "Weight": 1.0625, "ShowStopper": "No"}, {"Q": 6, "Section": "EM SC", "Question": "Dependant on legal clearance? ", "Notes": "Please consider: \n- CMAs to be signed off.\n- labour laws\n- Any 3rd party sourced (BAT is the supplier)", "Weight": 2.0, "ShowStopper": "Yes"}, {"Q": 7, "Section": "EM SC", "Question": "Dependant on engagement with tax authorities?", "Notes": "Including local reporting  requirements ", "Weight": 1.34375, "ShowStopper": "No"}, {"Q": 8, "Section": "SNO", "Question": "Dependant on TradeMark clearance? ", "Notes": "E.g. manufacturing of a specific brand moving to a different country for the first time", "Weight": 2.0, "ShowStopper": "Yes"}, {"Q": 9, "Section": "SNO", "Question": "Any touchpoints with Sanctioned Countries? ", "Notes": "Please take into account the new logistics lanes, too.", "Weight": 2.0, "ShowStopper": "Yes"}, {"Q": 10, "Section": "EM SC", "Question": "Will the initiative introduce a change on importation?", "Notes": "Please consider: \n- Customs clearance\n- rules of original complaince requirements \n- discriminatory excise from selected alternative source\n- Indirect tax/VAT; excise trigger points and paymeny terms \n- Secondary logistics requirements\n- Dangerous goods handling rules ", "Weight": 1.53125, "ShowStopper": "No"}, {"Q": 11, "Section": "Factory", "Question": "Will the initiative trigger installation or modification (repair) of any machinery at the receiving factory? ", "Notes": "This applies to any PMD, FMD or SMD machinery; installation/relocation between factories as well as new machinery. Modification includes the installation or removal of  parts or functionality, and format/collation changes; including repairs to increase output. ", "Weight": 1.90625, "ShowStopper": "No"}, {"Q": 12, "Section": "Factory", "Question": "Will the initiative necessitate new system at the receiving factory? ", "Notes": "E.g. track and trace, MES", "Weight": 1.53125, "ShowStopper": "No"}, {"Q": 13, "Section": "Factory", "Question": "Will the initiative trigger dismantling/moving of any machinery at the previous factory? ", "Notes": "nan", "Weight": 1.0625, "ShowStopper": "No"}, {"Q": 14, "Section": "Factory", "Question": "Additional offline tasks to be executed at receiving factory? ", "Notes": "Cutting tax stamps delivered in reels, secondary packaging, extra handling, re-labelling", "Weight": 0.96875, "ShowStopper": "No"}, {"Q": 15, "Section": "SNO", "Question": "Will the initiative necessitate offline demand planning and risk management (due to the offline nature of planning activities)? ", "Notes": "Please consider how volume transition and syncronisation between entities will be managed to avoid losing visibility or double-ordering", "Weight": 1.15625, "ShowStopper": "No"}, {"Q": 16, "Section": "EM SC", "Question": "Will the initiative change inventory levels?\n", "Notes": "Please consider stocks at:\n- for SFG, FG and WMS \n- at all warehouses including secondary warehouses and 3rd parties' (e.g. distributors)\n", "Weight": 1.0625, "ShowStopper": "No"}, {"Q": 17, "Section": "SNO", "Question": "Will the initiative necessitate extended warehousing capacity and/or new warehouse or new capability either in the current warehouse or the extension/new location?", "Notes": "1. Warehousing refers to any factory WH attached to the factory or any separate location for WMS and/or FGs, including consolidation hubs.  Please consider the new freight lanes when assessing WH availability. \n2. Even the factory team is responsible for own WH extensions, Global Logistics team will be involved. Hence the assesment to done together with Global Logistics team.\n3. Please consider primary and secondary distr. warehouses and bonded warehouses (again covered here but not in EM SC).", "Weight": 1.90625, "ShowStopper": "No"}, {"Q": 18, "Section": "SNO", "Question": "Will the initiative necessitate new system capabilities at the current and/or new warehouses? ", "Notes": "E.g. track and trace", "Weight": 1.53125, "ShowStopper": "No"}, {"Q": 19, "Section": "SNO", "Question": "Will the initiative necessitate change in warehousing setup at the previous source? ", "Notes": "Any 3rd party warehouse to be released?", "Weight": 1.0625, "ShowStopper": "No"}, {"Q": 20, "Section": "Factory", "Question": "Will the initiative necessitate any infrastructure changes at the receiving factory shop floor?", "Notes": "Please take into account that warehousing is covered in the previous point. ", "Weight": 1.71875, "ShowStopper": "No"}, {"Q": 21, "Section": "Factory", "Question": "Will the initiative introduce new manufacturing and/or warehousing processes at the receiving factory?", "Notes": "New SOP, SWP? Due to shift of ownership?", "Weight": 0.875, "ShowStopper": "No"}, {"Q": 22, "Section": "Factory", "Question": "Any factory trials, VAT, MQS for new suppliers, machinery, spec, profile at the receiving factory? ", "Notes": "A new spec refers to material or sub-material that is fundamentally different in composition, construction, design or performance to existing materials (e.g. super-opaque high chalk papers, non-CA filter materials). It does not include changes to presentation or visual appearance.  ", "Weight": 1.625, "ShowStopper": "No"}, {"Q": 23, "Section": "Procurement", "Question": "Will the initiative change suppliers' network for any globally managed direct material groups (either change of suppliers or their sites) ", "Notes": " See the list of \"Globally Managed Mat\"", "Weight": 1.34375, "ShowStopper": "No"}, {"Q": 24, "Section": "Procurement", "Question": "Will the initiative impact any volume commitments to suppliers? ", "Notes": "E.g. volume to be purchased to avoid a penalty", "Weight": 1.4375, "ShowStopper": "No"}, {"Q": 25, "Section": "Procurement", "Question": "Will the initiative impact business model for the suppliers? ", "Notes": "E.g. printers severely impacted by our factory closures - in return impacting our other sites.", "Weight": 1.53125, "ShowStopper": "No"}, {"Q": 26, "Section": "Procurement", "Question": "Will the initiative trigger a new vendor exploration (for the globally managed material) - due diligence - qualification?", "Notes": "E.g. The exploration of SB pack supplier for AGW ", "Weight": 1.53125, "ShowStopper": "No"}, {"Q": 27, "Section": "Procurement", "Question": "Will there be a capability gap at future suppliers -  requiring investments?", "Notes": "nan", "Weight": 1.34375, "ShowStopper": "No"}, {"Q": 28, "Section": "Procurement", "Question": "Will the initiative impact supplier BCPs already in place? ", "Notes": "nan", "Weight": 0.96875, "ShowStopper": "No"}, {"Q": 29, "Section": "Leaf", "Question": "Will there be a blend modification? ", "Notes": "Please see \"Leaf\" tab and the notes. Answer considering \n- volume;\n- leaf availability/crop connections; \n- GLP reaction timings; \n- regulatory compliance requirements;\n- import duties.\nDoes not apply to MO. ", "Weight": 1.53125, "ShowStopper": "No"}, {"Q": 30, "Section": "EM SC", "Question": "Will the initiative trigger consumer noticeable changes?", "Notes": "Answer considering \n- risk log of the project;\n- internal product tests or a consumer research requirements in case of any product changes;\n- any change driven by the manufacturing capabilities (like flavour application, collation, number of sticks);\n- any change due to regulation applicable to manufacturing site (like 10-1-10);\n- any change driven by the supplier capability limitations.", "Weight": 1.4375, "ShowStopper": "No"}, {"Q": 31, "Section": "EM SC", "Question": "Will the initiative necessitate physical logistics trials?  ", "Notes": "Test for E2E SC quality conformity and decision on transport mode (in case multiple options are available) and the warehousing conditioning requirements (incl. temperature, humidity). \nThis question is not referring to desktop User Acceptance Tests.", "Weight": 1.53125, "ShowStopper": "No"}, {"Q": 32, "Section": "EM SC", "Question": "Will the initiative trigger sensitivity around SoM change?", "Notes": "E.g. KSA sensitivity for sourcing ex-Europe.", "Weight": 1.4375, "ShowStopper": "No"}, {"Q": 33, "Section": "EM SC", "Question": "Will initiative require policy/procedure updates on planning and distribution?", "Notes": "As in \n- SHP \n- Quality - shelf life etc.", "Weight": 0.875, "ShowStopper": "No"}, {"Q": 34, "Section": "EM SC", "Question": "New HLD (High Level Design) requirement?", "Notes": "Mapping product movement and invoicing activities between plants/entities (in case the route is not already established)", "Weight": 0.96875, "ShowStopper": "No"}, {"Q": 35, "Section": "EM SC", "Question": "New plant setup requirement on SAP?", "Notes": "E.g. bandrole plant, logistics routes ", "Weight": 1.4375, "ShowStopper": "No"}, {"Q": 36, "Section": "Factory", "Question": "Will the initiative trigger union negotiations at the receiving factory?", "Notes": "- Shift pattern changes\n- task modifications on the current agreement", "Weight": 1.625, "ShowStopper": "No"}, {"Q": 37, "Section": "Factory", "Question": "Will the initiative trigger union negotiations at the previous factory?", "Notes": "- Shift pattern changes \n- factory closures ", "Weight": 1.625, "ShowStopper": "No"}, {"Q": 38, "Section": "EM SC", "Question": "Any new contract requirement between BAT entities (e.g. NVT contract if HLD is changing)", "Notes": "nan", "Weight": 1.15625, "ShowStopper": "No"}, {"Q": 39, "Section": "EM SC", "Question": "Any change requirement OR early termination of the existing contracts between 3rd parties? ", "Notes": "Any lease agreements etc.", "Weight": 1.25, "ShowStopper": "No"}, {"Q": 40, "Section": "SNO", "Question": "Will the initiative create a negative impact on sustainability score?", "Notes": "nan", "Weight": 1.25, "ShowStopper": "No"}, {"Q": 41, "Section": "Factory", "Question": "Any additonal environmental liabilities due to change of source? Need for environmental audit?", "Notes": "nan", "Weight": 0.875, "ShowStopper": "No"}, {"Q": 42, "Section": "EM SC", "Question": "Does the initative has any interdependencies with upcoming commercial/portfolio plans?", "Notes": "Clashing priorities or consolidation opportunities", "Weight": 0.96875, "ShowStopper": "No"}, {"Q": 43, "Section": "SNO", "Question": "Does the initiative change the current sourcing/forrprint for 3rd parties (BAT as supplier)? ", "Notes": "Like in Tango", "Weight": 1.4375, "ShowStopper": "No"}, {"Q": 44, "Section": "EM SC", "Question": "High industrial relations and/or reputation risks?", "Notes": "nan", "Weight": 1.0625, "ShowStopper": "No"}, {"Q": 45, "Section": "SNO", "Question": "Is the initiative outside of the annual OPS productivity cycle plan which has already been shared with other functions for resource planning purposes?", "Notes": "Under NDA,  prior visibility will not be possible. The question refers to a consolidated visibility without mentioning initiatives to help with resource manegement at supporting functions (PSMT, packaging, product etc.)", "Weight": 0.875, "ShowStopper": "No"}, {"Q": 46, "Section": "Factory", "Question": "Specific tax stamp management/reconciliation requirements?", "Notes": "nan", "Weight": 1.25, "ShowStopper": "No"}], "answers": {"Tango": {"1": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 0.96875}, "2": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "3": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 0.96875}, "4": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "5": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.0625}, "6": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 2.0}, "7": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "8": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 2.0}, "9": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "10": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "11": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.90625}, "12": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "13": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.0625}, "14": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "15": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.15625}, "16": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.0625}, "17": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.90625}, "18": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "19": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.0625}, "20": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "21": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 0.875}, "22": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.625}, "23": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "24": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "25": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "26": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "27": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "28": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "29": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "30": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "31": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "32": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "33": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 0.875}, "34": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 0.96875}, "35": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.4375}, "36": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "37": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.625}, "38": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "39": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.25}, "40": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "41": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "42": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "43": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "44": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.0625}, "45": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 0.875}, "46": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.25}}, "Frida": {"1": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 0.96875}, "2": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "3": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 0.96875}, "4": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "5": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.0625}, "6": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 2.0}, "7": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.34375}, "8": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 2.0}, "9": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "10": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "11": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.90625}, "12": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.53125}, "13": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "14": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "15": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.15625}, "16": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.0625}, "17": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.90625}, "18": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.53125}, "19": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "20": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "21": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 0.875}, "22": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.625}, "23": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "24": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "25": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "26": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "27": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "28": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "29": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "30": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "31": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "32": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "33": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 0.875}, "34": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "35": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.4375}, "36": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 1.625}, "37": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "38": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "39": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "40": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "41": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "42": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "43": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "44": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}, "45": {"Answer": "Yes", "AnswerBinary": 1.0, "WeightedScore": 0.875}, "46": {"Answer": "No", "AnswerBinary": 0.0, "WeightedScore": 0.0}}}, "bottlenecks": [{"Rank": 1, "Area": "Legal", "Question#": "Q6 – Legal clearance (e.g., CMAs)", "Potential bottlenecks": "Gating dependency for both projects; potential delays in delivery.", "Combined Weight": 4.0, "Probable mitigations": "Joint legal resources with a unified tracker and escalation path covering the entire project portfolio."}, {"Rank": 2, "Area": "Trademark", "Question#": "Q7 – TM clearance", "Potential bottlenecks": "Same critical‑path behavior as legal; brand/site moves require approvals before factory and system work can meaningfully start.", "Combined Weight": 4.0, "Probable mitigations": "Agreed SLA and unified tracker to feed into project timelines. "}, {"Rank": 3, "Area": "Factory Enablement", "Question#": "Q10 – Install/modify machinery", "Potential bottlenecks": "Competes for engineering, OEM sources.", "Combined Weight": 3.81, "Probable mitigations": "Global calendar to align timing for shared resources"}, {"Rank": 4, "Area": "Warehousing", "Question#": "Q13 – Extra WH capacity/capability", "Potential bottlenecks": "Parallel needs for capacity (space) and capability (e.g., T&T) at factory/central hubs. ", "Combined Weight": 3.81, "Probable mitigations": "Global Logistics plan consolidation - involve global team at early stages of exploration"}, {"Rank": 5, "Area": "Trials & Qualification", "Question#": "Q16 – Trials / VAT / MQS", "Potential bottlenecks": "Concurrent trials", "Combined Weight": 3.25, "Probable mitigations": "If competing for global involvement, apply global calendar practice. "}, {"Rank": 6, "Area": "Inventory/BAU", "Question#": "Q12 – BAU inventory level changes", "Potential bottlenecks": "Overall WC impact", "Combined Weight": 2.13, "Probable mitigations": "Financial impact presented at group level; not limited at entity level."}, {"Rank": 7, "Area": "CSP", "Question#": "Q5 – CSP change", "Potential bottlenecks": "Repetitive changes in the plans", "Combined Weight": 2.13, "Probable mitigations": "Updates restricted with regular review cycles (if project implementation timings approx. 8-12 months)"}, {"Rank": 8, "Area": "Filter Supply ", "Question#": "Q1 – Filter supplier change", "Potential bottlenecks": "Individiual capacity and capability checks at project level", "Combined Weight": 1.94, "Probable mitigations": "Only in-house supply. Sensitivities applied on RCCP"}]};
</script>

<script>
  const state = { metric:'ImpactWeights', selectedProjects:new Set(STEP12.projects), focusProject:STEP12.projects[0], section:'All', search:'' };

  const projectSelect = document.getElementById('projectSelect');
  const metricSelect  = document.getElementById('metricSelect');
  const projectChecks = document.getElementById('projectChecks');
  const sectionFilter = document.getElementById('sectionFilter');
  const searchBox     = document.getElementById('searchBox');

  STEP12.projects.forEach(p => { const opt=document.createElement('option'); opt.value=p; opt.textContent=p; projectSelect.appendChild(opt); });
  projectSelect.value = state.focusProject;

  STEP12.projects.forEach(p => {
    const id='chk_'+p;
    const div=document.createElement('div');
    div.className='form-check';
    div.innerHTML = `<input class="form-check-input" type="checkbox" id="${id}" checked><label class="form-check-label" for="${id}">${p}</label>`;
    projectChecks.appendChild(div);
    div.querySelector('input').addEventListener('change', (e)=>{
      if(e.target.checked) state.selectedProjects.add(p); else state.selectedProjects.delete(p);
      if(!state.selectedProjects.has(state.focusProject)) {
        const first=[...state.selectedProjects][0];
        if(first) { state.focusProject=first; projectSelect.value=first; }
      }
      renderAll();
    });
  });

  ['All', ...STEP12.sections].forEach(s => { const opt=document.createElement('option'); opt.value=s; opt.textContent=s; sectionFilter.appendChild(opt); });

  metricSelect.addEventListener('change', e => { state.metric=e.target.value; renderAll(); });
  projectSelect.addEventListener('change', e => { state.focusProject=e.target.value; renderStep1(); });
  sectionFilter.addEventListener('change', e => { state.section=e.target.value; renderStep3(); });
  searchBox.addEventListener('input', e => { state.search=(e.target.value||'').toLowerCase(); renderStep3(); });

  function selectedProjects(){ return STEP12.projects.filter(p => state.selectedProjects.has(p)); }
  function safe(v){ return (v===null || v===undefined || Number.isNaN(v)) ? null : v; }

  function renderStep1(){
    const p=state.focusProject;
    const sec=STEP12.sections;
    const vals=sec.map(s => safe(STEP12.impacts[p]?.[s]?.[state.metric]) ?? 0);

    const cum=STEP12.impacts[p]?.['Cumulative'] || {};
    const totalImpact=safe(cum[state.metric]);
    const yes=safe(cum.Yes);
    const resp=safe(cum.Responses);

    document.getElementById('kpiTotal').textContent = (totalImpact==null)?'–':totalImpact.toFixed(3);
    document.getElementById('kpiYes').textContent   = (yes==null)?'–':yes;
    document.getElementById('kpiResp').textContent  = (resp==null)?'–':resp;

    const data=[{ type:'scatterpolar', r: vals.concat(vals[0]), theta: sec.concat(sec[0]), fill:'toself', name:p, line:{color:'#0B6FB8'} }];
    const layout={
      paper_bgcolor:'#ffffff', plot_bgcolor:'#ffffff',
      font:{color:'#0b1f33'},
      polar:{ bgcolor:'#ffffff', radialaxis:{visible:true, range:[0,1], gridcolor:'rgba(15,23,42,.12)', tickfont:{color:'#526173'}}, angularaxis:{tickfont:{color:'#526173'}} },
      margin:{l:40,r:40,t:20,b:20},
      showlegend:false,
      title:{text:`Impact profile – ${p}`, font:{size:16, color:'#0e2b63'}}
    };
    Plotly.newPlot('radar', data, layout, {displayModeBar:false, responsive:true});
  }

  function renderStep2(){
    const ps=selectedProjects();
    const sec=STEP12.sections;
    const traces=ps.map(p=>({ type:'bar', name:p, x:sec, y: sec.map(s => safe(STEP12.impacts[p]?.[s]?.[state.metric]) ?? 0) }));
    const layout={
      barmode:'group', paper_bgcolor:'#ffffff', plot_bgcolor:'#ffffff',
      font:{color:'#0b1f33'},
      margin:{l:40,r:20,t:30,b:40},
      yaxis:{range:[0,1], gridcolor:'rgba(15,23,42,.12)'},
      title:{text:`Comparison across functions (${state.metric==='ImpactWeights'?'weights':'count'})`, font:{size:16, color:'#0e2b63'}}
    };
    Plotly.newPlot('compareBar', traces, layout, {displayModeBar:false, responsive:true});
  }

  let qTable=null;
  function filteredQuestions(){
    const ps=selectedProjects();
    let meta=STEP3.questionMeta;
    if(state.section!=='All') meta=meta.filter(m=>m.Section===state.section);
    if(state.search) meta=meta.filter(m=>(m.Question||'').toLowerCase().includes(state.search));
    return meta.map(m=>{
      const row={...m};
      ps.forEach(p=>{ const a=STEP3.answers[p]?.[m.Q]; row[p]=(state.metric==='ImpactWeights')?(a?.WeightedScore ?? null):(a?.AnswerBinary ?? null); });
      return row;
    });
  }

  function renderHeatmap(rows){
    const ps=selectedProjects();
    const y=rows.map(r=>`Q${r.Q}`);
    const z=rows.map(r=>ps.map(p=> r[p]==null? null : r[p]));
    const hover=rows.map(r=>ps.map(p=>{
      const a=STEP3.answers[p]?.[r.Q] || {};
      const metricVal=(state.metric==='ImpactWeights')?(a.WeightedScore ?? '—'):(a.AnswerBinary ?? '—');
      const ans=a.Answer ?? '—';
      return `<b>${p}</b><br>Q${r.Q} • ${r.Section}<br>${r.Question}<br><br>Answer: <b>${ans}</b><br>Weight: ${r.Weight}<br>Value: ${metricVal}`;
    }));

    const scaleYesNo=[[0,'#f7fbff'],[0.35,'#c6dbef'],[0.7,'#6baed6'],[1,'#08519c']];
    const data=[{ type:'heatmap', x:ps, y:y, z:z, text:hover, hoverinfo:'text',
      colorscale:(state.metric==='ImpactWeights')?'Blues':scaleYesNo,
      zmin:0, zmax:(state.metric==='ImpactWeights')?2.0:1.0,
      showscale:true, colorbar:{tickfont:{color:'#526173'}}
    }];
    const layout={ paper_bgcolor:'#ffffff', plot_bgcolor:'#ffffff', font:{color:'#0b1f33'}, margin:{l:70,r:20,t:30,b:40},
      title:{text:`Consolidated impact map (${state.metric==='ImpactWeights'?'weighted score':'yes/no'})`, font:{size:16, color:'#0e2b63'}},
      xaxis:{tickfont:{color:'#526173'}}, yaxis:{tickfont:{color:'#526173'}}
    };
    Plotly.newPlot('heatmap', data, layout, {displayModeBar:false, responsive:true});

    document.getElementById('heatmap').on('plotly_click', (evt)=>{
      const yLabel=evt.points?.[0]?.y || '';
      const q=parseInt((yLabel+'').replace('Q',''),10);
      if(qTable){ qTable.selectRow(q); document.getElementById('qTable').scrollIntoView({behavior:'smooth', block:'start'}); }
    });
  }

  function renderTable(rows){
    const ps=selectedProjects();
    const cols=[
      {title:'Q', field:'Q', width:70, sorter:'number'},
      {title:'Section', field:'Section', width:120},
      {title:'Question', field:'Question', widthGrow:3},
      {title:'Weight', field:'Weight', width:90, sorter:'number'},
      {title:'Show-stopper', field:'ShowStopper', width:120}
    ];
    ps.forEach(p=>cols.push({title:p, field:p, sorter:'number', width:110, formatter:(cell)=>{
      const v=cell.getValue();
      if(v==null) return '<span class="muted">–</span>';
      if(state.metric==='ImpactWeights') return Number(v).toFixed(3);
      return v===1?'<b>Yes</b>':'No';
    }}));

    if(!qTable) qTable=new Tabulator('#qTable', {data:rows, index:'Q', layout:'fitDataStretch', height:'520px', selectable:1, columns:cols});
    else { qTable.setColumns(cols); qTable.setData(rows); }

    document.getElementById('tableCount').textContent = `${rows.length} questions shown`;
  }

  function renderStep3(){
    const rows=filteredQuestions();
    renderHeatmap(rows);
    renderTable(rows);
  }

  let hotspotTable=null, bottleneckTable=null;
  function renderStep4(){
    const ps=selectedProjects();
    const meta=STEP3.questionMeta;
    const rows=meta.map(m=>{
      let yes=0,total=0,wsum=0;
      ps.forEach(p=>{ const a=STEP3.answers[p]?.[m.Q]; if(a?.AnswerBinary==null) return; total++; yes += (a.AnswerBinary===1?1:0); wsum += (a.WeightedScore||0); });
      return {Q:m.Q, Section:m.Section, Question:m.Question, YesRate: total?(yes/total):null, YesCount:yes, WeightedSum:wsum};
    }).sort((a,b)=>(b.YesRate||0)-(a.YesRate||0) || (b.WeightedSum||0)-(a.WeightedSum||0));

    const hCols=[
      {title:'Q', field:'Q', width:70, sorter:'number'},
      {title:'Section', field:'Section', width:120},
      {title:'Yes rate', field:'YesRate', width:110, sorter:'number', formatter:(c)=> c.getValue()==null?'–':(100*c.getValue()).toFixed(0)+'%'},
      {title:'Yes count', field:'YesCount', width:100, sorter:'number'},
      {title:'Weighted sum', field:'WeightedSum', width:130, sorter:'number', formatter:(c)=>(c.getValue()||0).toFixed(3)},
      {title:'Question', field:'Question', widthGrow:3}
    ];
    if(!hotspotTable) hotspotTable=new Tabulator('#hotspotTable', {data:rows, layout:'fitDataStretch', height:'520px', columns:hCols});
    else hotspotTable.setData(rows);

    const bCols=[
      {title:'Rank', field:'Rank', width:80, sorter:'number'},
      {title:'Area', field:'Area', width:140},
      {title:'Question#', field:'Question#', width:130},
      {title:'Combined Weight', field:'Combined Weight', width:140},
      {title:'Potential bottlenecks', field:'Potential bottlenecks', widthGrow:2},
      {title:'Probable mitigations', field:'Probable mitigations', widthGrow:2}
    ];
    if(!bottleneckTable) bottleneckTable=new Tabulator('#bottleneckTable', {data:STEP3.bottlenecks, layout:'fitDataStretch', height:'520px', columns:bCols});
  }

  function renderAll(){ renderStep1(); renderStep2(); renderStep3(); renderStep4(); }
  renderAll();
</script>
</body>
</html>
