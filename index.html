<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>SND Impact – Steps #1–#4 (Interactive)</title>

  <style>
    :root{
      --ink:#0b1f33;
      --muted:#6b7a8c;
      --blue:#0B6FB8;
      --blue2:#66A3D2;
      --navy:#003366;
      --bg:#f5f7fa;
      --card:#ffffff;
      --border:#e3e8ef;
    }

    *{box-sizing:border-box;}
    body{
      margin:24px;
      font-family: Segoe UI, Arial, sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    main.wrap{max-width:1200px; margin:0 auto;}

    h1{color:var(--navy); margin:0 0 12px; font-size:24px;}
    h2{color:var(--navy); margin:0 0 8px; font-size:18px;}

    .card{
      background:var(--card);
      border-radius:14px;
      box-shadow:0 8px 24px rgba(0,0,0,.08);
      padding:18px;
      margin-bottom:18px;
    }

    .title-row{display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;}
    .right{display:flex; align-items:center; gap:10px;}

    .grid{display:grid; grid-template-columns: 1.3fr 1fr; gap:20px; align-items:start;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    label{font-size:14px; color:var(--navy);}
    select, input[type="text"], input[type="date"], textarea{
      border:1px solid #d4deee;
      border-radius:8px;
      padding:8px 10px;
      font-size:14px;
      color:var(--navy);
      background:#ffffff;
    }
    select{background:#f7fbff;}

    fieldset{border:1px solid var(--border); border-radius:10px; padding:10px 12px;}
    legend{font-size:12px; color:var(--muted);}
    input[type="checkbox"]{accent-color:var(--blue);}

    .panel{display:flex; gap:16px; align-items:center; flex-wrap:wrap;}
    .chip{font-size:12px; padding:5px 9px; border-radius:999px; border:1px solid var(--border); background:#eef6ff; color:var(--navy);}

    .kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:10px;}
    .kpi{background:#f0f6ff; border:1px solid #e1ecfb; border-radius:10px; padding:10px;}
    .kpi .v{font-weight:700; font-size:18px; color:#005EB8;}

    table{width:100%; border-collapse:collapse; font-size:14px;}
    th, td{padding:10px 8px; text-align:left; border-bottom:1px solid #eef2f7; vertical-align:top;}
    th{color:var(--navy); font-weight:600;}

    .heat{border-collapse:separate; border-spacing:0;}
    .heat th{position:sticky; top:0; background:var(--card); z-index:1;}

    .bar{height:10px; background:#e9eef6; border-radius:6px; overflow:hidden;}
    .bar > span{display:block; height:100%; background:linear-gradient(90deg,var(--blue2),var(--blue));}

    p.note, .note{color:var(--muted); font-size:12px; margin:8px 0 0;}

    /* Step #1 Radar */
    #radarWrap{position:relative;}
    #tooltip{
      position:absolute;
      pointer-events:none;
      background:var(--ink);
      color:#fff;
      font-size:12px;
      padding:8px 10px;
      border-radius:8px;
      box-shadow:0 4px 14px rgba(0,0,0,.2);
      opacity:0;
      transform: translate(-50%, -120%);
      transition: opacity .12s ease;
      white-space:nowrap;
    }
    .tick-label{fill:var(--muted); font-size:11px;}
    .axis-label{fill:var(--navy); font-size:12px; font-weight:600;}

    /* Step #3 Top 5 bars */
    .bar-list{display:flex; flex-direction:column; gap:12px;}
    .bar-item{width:100%; max-width:780px;}
    .bar-label{font-size:14px; font-weight:600; color:var(--ink); margin-bottom:6px;}
    .bar-track{height:10px; background:#e9eef6; border-radius:6px; margin-bottom:4px;}
    .bar-fill{height:10px; border-radius:6px; background:linear-gradient(90deg, var(--blue2), var(--blue));}
    .bar-stats{font-size:12px; color:#51606f;}

    /* Step #3 multi-select */
    .secLbl{display:block; margin:0 0 6px 0; font-weight:600; color:var(--navy);}
    #secSel{display:block; min-width:200px; background:#ffffff;}
    #secSel option{background:#ffffff; color:var(--ink);}
    #secSel option:checked{background-color:#0e2b63 !important; color:#ffffff !important;}

    /* Step #4 */
    .btnLink{border:1px solid #d4deee; background:#f7fbff; color:var(--navy); padding:6px 10px; border-radius:8px; cursor:pointer; font-size:12px;}
    .hlRow{outline:2px solid rgba(11,111,184,0.8); outline-offset:-2px;}
    .inpCell{width:100%; border:1px solid #d4deee; border-radius:8px; padding:6px 8px; font-size:12px; background:#fff; color:var(--ink);}
    .selCell{width:100%; border:1px solid #d4deee; border-radius:8px; padding:6px 8px; font-size:12px; background:#fff; color:var(--ink);}
    #step4Tbl td:nth-child(4){min-width:420px;}

    svg{width:100%; height:auto;}
    .pt{stroke:#fff; stroke-width:1.5;}
  </style>
</head>

<body>
<main class="wrap">

  <!-- Step #1 -->
  <section class="card" aria-label="Step 1">
    <div class="title-row">
      <h1>Step #1 – Impact Profile (Interactive)</h1>
      <div class="right">
        <label for="projectSel" style="color:#4a5a6a;font-weight:600;">Project</label>
        <select id="projectSel" aria-label="Select project">
          <option value="Astro">Astro</option>
          <option value="Tango" selected>Tango</option>
        </select>
      </div>
    </div>

    <div class="grid">
      <div id="radarWrap">
        <svg id="radarSvg" viewBox="0 0 560 560" preserveAspectRatio="xMidYMid meet" aria-label="Radar chart"></svg>
        <div id="tooltip" role="tooltip"></div>
        <div class="panel" style="margin-top:8px;">
          <span class="chip">Scale: 0 (low) to 1 (high)</span>
          <span class="chip">Metric: Weighted impact</span>
        </div>
      </div>

      <div>
        <h2>Snapshot</h2>
        <div class="kpis">
          <div class="kpi"><div>Questions</div><div id="kpiQ" class="v">—</div></div>
          <div class="kpi"><div>Yes</div><div id="kpiYes" class="v">0</div></div>
          <div class="kpi"><div>No</div><div id="kpiNo" class="v">0</div></div>
        </div>
        <div class="kpi" style="margin-top:12px;">
          <div>Average weighted impact</div>
          <div id="kpiAvg" class="v">0.00</div>
        </div>

        <h2 style="margin-top:16px;">Top impacted functions</h2>
        <table id="topTbl" aria-label="Top impacted functions">
          <thead>
            <tr>
              <th>Function</th>
              <th style="width:40%">Impact</th>
              <th style="width:80px; text-align:right;">Score</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="card" aria-label="Step 1 detail">
    <h2>Detail by function</h2>
    <table id="detailTbl" aria-label="Detail by function">
      <thead>
        <tr>
          <th>Function</th>
          <th>#Yes</th>
          <th>#No</th>
          <th>Impact (count)</th>
          <th>Weighted impact</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Step #2 -->
  <section class="card" aria-label="Step 2">
    <h1>Step #2 — Portfolio Aggregation (Weighted by Base)</h1>
    <div class="panel">
      <fieldset>
        <legend>Projects</legend>
        <label><input type="checkbox" class="proj" value="Astro" checked> Astro</label>
        <label style="margin-left:10px"><input type="checkbox" class="proj" value="Tango" checked> Tango</label>
      </fieldset>
      <span class="chip">Scale: 0 (low) to 1 (high)</span>
    </div>
    <div class="kpis" id="kpiRow"></div>
  </section>

  <section class="card" aria-label="Step 2 charts">
    <div class="grid">
      <div>
        <h2>Function Impact Comparison</h2>
        <div id="dbWrap">
          <svg id="dbSvg" viewBox="0 0 760 420" preserveAspectRatio="xMidYMid meet" aria-label="Dumbbell chart"></svg>
        </div>
        <p class="note">Circles = project values; diamond = weighted aggregate. Sorted by aggregate.</p>
      </div>
      <div>
        <h2>Heatmap View</h2>
        <table class="heat" id="heatTbl" aria-label="Heatmap">
          <thead><tr><th>Function</th><th>Average</th><th>Astro</th><th>Tango</th></tr></thead>
          <tbody></tbody>
        </table>
        <p class="note">Cell color intensity reflects impact magnitude. Sorted by aggregate.</p>
      </div>
    </div>
  </section>

  <!-- Step #3 -->
  <section class="card" aria-label="Step 3">
    <h1>Step #3 — Consolidated Impact Map (Question‑Level)</h1>

    <div class="kpi" style="margin:10px 0;">
      <div style="font-weight:600;color:var(--navy);margin-bottom:6px">Top 5 Recurring Impact Drivers Across Projects:</div>
      <div class="bar-list" id="top5Bars"></div>
    </div>

    <h2 style="margin-top:6px">Interactive Matrix</h2>

    <div class="panel" style="margin:8px 0;">
      <fieldset>
        <legend>Filter</legend>
        <label class="secLbl" for="secSel">Section</label>
        <select id="secSel" multiple size="6" aria-label="Filter by section"></select>
      </fieldset>
      <span class="chip">White = No impact · Light blue = Yes (low) · Darker blue = Yes (heavy)</span>
    </div>

    <div class="panel" style="margin:8px 0; justify-content:space-between;">
      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <label style="color:#4a5a6a;font-weight:600;" for="qSearch">Search</label>
        <input id="qSearch" type="text" placeholder="Search question text" aria-label="Search questions" />
      </div>
      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <label style="color:#4a5a6a;font-weight:600;" for="thrSel">Heavy threshold</label>
        <select id="thrSel" aria-label="Select heavy threshold">
          <option value="1.25">≥ 1.25</option>
          <option value="1.50" selected>≥ 1.50</option>
          <option value="1.75">≥ 1.75</option>
          <option value="1.90">≥ 1.90</option>
        </select>
      </div>
    </div>

    <table class="heat" id="step3Tbl" aria-label="Question-level impact matrix">
      <thead></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Step #4 -->
  <section class="card" aria-label="Step 4">
    <h1>Step #4 — Portfolio Bottlenecks & Actions</h1>

    <div class="panel" style="margin:8px 0;">
      <fieldset>
        <legend>Projects</legend>
        <div id="step4ProjCbs"></div>
        <div style="margin-top:10px;">
          <label><input type="checkbox" id="sharedOnly" checked> Shared only (≥2 projects)</label>
        </div>
      </fieldset>

      <fieldset style="flex:1; min-width:260px;">
        <legend>Search</legend>
        <input id="step4Search" type="text" placeholder="Search bottleneck / mitigation / owner / notes" aria-label="Search bottlenecks" style="width:100%;" />
      </fieldset>
    </div>

    <div class="kpis" id="step4Kpis"></div>

    <h2 style="margin-top:14px;">Bottleneck register (editable)</h2>
    <table class="heat" id="step4Tbl" aria-label="Bottleneck register">
      <thead></thead>
      <tbody></tbody>
    </table>

    <p class="note">Edits are saved locally in your browser (works on GitHub Pages without a server).</p>
  </section>

</main>

<script>
  // Embedded data (copied from your original HTML)
  const DATA = {"Astro": {"rows": [{"Function": "SNO", "#Yes": 9, "#No": 2, "Impact_count": 0.8181818181818182, "Weighted_Responses": 12.1875, "Weighted_Base": 15.0625, "Impact_weights": 0.8091286307053942}, {"Function": "Leaf", "#Yes": 1, "#No": 0, "Impact_count": 1.0, "Weighted_Responses": 1.53125, "Weighted_Base": 1.53125, "Impact_weights": 1.0}, {"Function": "Procurement", "#Yes": 4, "#No": 2, "Impact_count": 0.6666666666666666, "Weighted_Responses": 5.1875, "Weighted_Base": 8.15625, "Impact_weights": 0.6360153256704981}, {"Function": "Factory", "#Yes": 3, "#No": 2, "Impact_count": 0.6, "Weighted_Responses": 4.5, "Weighted_Base": 7.09375, "Impact_weights": 0.6343612334801763}, {"Function": "EM SC", "#Yes": 5, "#No": 5, "Impact_count": 0.5, "Weighted_Responses": 5.125, "Weighted_Base": 12.125, "Impact_weights": 0.422680412371134}], "note": "Astro \u2013 function summary parsed from the Astro sheet."}, "Tango": {"rows": [{"Function": "SNO", "#Yes": 7, "#No": 4, "Impact_count": 0.6363636363636364, "Weighted_Responses": 9.78125, "Weighted_Base": 15.0625, "Impact_weights": 0.6493775933609959}, {"Function": "Leaf", "#Yes": 0, "#No": 1, "Impact_count": 0.0, "Weighted_Responses": 0.0, "Weighted_Base": 1.53125, "Impact_weights": 0.0}, {"Function": "Procurement", "#Yes": 0, "#No": 6, "Impact_count": 0.0, "Weighted_Responses": 0.0, "Weighted_Base": 8.15625, "Impact_weights": 0.0}, {"Function": "Factory", "#Yes": 3, "#No": 2, "Impact_count": 0.6, "Weighted_Responses": 4.40625, "Weighted_Base": 7.09375, "Impact_weights": 0.6211453744493393}, {"Function": "EM SC", "#Yes": 4, "#No": 6, "Impact_count": 0.4, "Weighted_Responses": 4.34375, "Weighted_Base": 12.125, "Impact_weights": 0.3582474226804124}], "note": "Rows 49\u201355 from the Tango tab (summary by function)."}};
  window.STEP3 = {"projects": ["Astro", "Tango"], "rows": [{"section": "EM SC", "q": 9, "question": "Will the initiative introduce a change on importation?", "projects": {"Astro": {"answer": "Yes", "weight": 1.25}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "EM SC", "q": 12, "question": "Will the initiative change inventory levels for FGs, SFGs or WMS in the future BAU operations?", "projects": {"Astro": {"answer": "Yes", "weight": 1.0625}, "Tango": {"answer": "Yes", "weight": 1.0625}}}, {"section": "EM SC", "q": 24, "question": "Will the initiative trigger consumer noticeable changes?", "projects": {"Astro": {"answer": "No", "weight": 0.0}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "EM SC", "q": 25, "question": "Will the initiative necessitate physical logistics trials?", "projects": {"Astro": {"answer": "No", "weight": 0.0}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "EM SC", "q": 26, "question": "Will the initiative trigger sensitivity around SoM change?", "projects": {"Astro": {"answer": "No", "weight": 0.0}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "EM SC", "q": 27, "question": "Will initiative require policy/procedure updates on planning and distribution?", "projects": {"Astro": {"answer": "Yes", "weight": 0.875}, "Tango": {"answer": "Yes", "weight": 0.875}}}, {"section": "EM SC", "q": 28, "question": "New HLD requirement?", "projects": {"Astro": {"answer": "Yes", "weight": 0.96875}, "Tango": {"answer": "Yes", "weight": 0.96875}}}, {"section": "EM SC", "q": 29, "question": "SAP setup requirement?", "projects": {"Astro": {"answer": "No", "weight": 0.0}, "Tango": {"answer": "Yes", "weight": 1.4375}}}, {"section": "EM SC", "q": 30, "question": "Any new contract requirement between BAT entities (e.g. NVT contract if HLD is changing)", "projects": {"Astro": {"answer": "No", "weight": 0.0}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "EM SC", "q": 32, "question": "Does the initative has any interdependencies with upcoming commercial/portfolio plans?", "projects": {"Astro": {"answer": "Yes", "weight": 0.96875}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "Factory", "q": 10, "question": "Will the initiative trigger installation or modification of any machinery at the receiving factory?", "projects": {"Astro": {"answer": "Yes", "weight": 1.90625}, "Tango": {"answer": "Yes", "weight": 1.90625}}}, {"section": "Factory", "q": 11, "question": "Additional offline tasks to be executed at receiving factory?", "projects": {"Astro": {"answer": "Yes", "weight": 0.96875}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "Factory", "q": 14, "question": "Will the initiative necessitate any infrastructure changes at the receiving factory shop floor?", "projects": {"Astro": {"answer": "No", "weight": 0.0}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "Factory", "q": 15, "question": "Will the initiative introduce new manufacturing and/or warehousing processes at the receiving factory?", "projects": {"Astro": {"answer": "No", "weight": 0.0}, "Tango": {"answer": "Yes", "weight": 0.875}}}, {"section": "Factory", "q": 16, "question": "Any factory trials, VAT, MQS for new suppliers, machinery, spec, profile at the receiving factory?", "projects": {"Astro": {"answer": "Yes", "weight": 1.625}, "Tango": {"answer": "Yes", "weight": 1.625}}}, {"section": "Leaf", "q": 23, "question": "Will there be a blend modification?", "projects": {"Astro": {"answer": "Yes", "weight": 1.53125}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "Procurement", "q": 17, "question": "Will the initiative change suppliers' network for any globally managed direct material groups (either change of suppliers or their sites)", "projects": {"Astro": {"answer": "Yes", "weight": 1.34375}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "Procurement", "q": 18, "question": "Will the initiative impact any volume commitments to suppliers?", "projects": {"Astro": {"answer": "No", "weight": 0.0}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "Procurement", "q": 19, "question": "Will the initiative impact business model for the suppliers?", "projects": {"Astro": {"answer": "Yes", "weight": 1.53125}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "Procurement", "q": 20, "question": "Will the initiative trigger a new vendor exploration (for the globally managed material) - due diligence - qualification?", "projects": {"Astro": {"answer": "No", "weight": 0.0}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "Procurement", "q": 21, "question": "Will there be a capability gap at future suppliers -  requiring investments?", "projects": {"Astro": {"answer": "Yes", "weight": 1.34375}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "Procurement", "q": 22, "question": "Will the initiative impact supplier BCPs already in place?", "projects": {"Astro": {"answer": "Yes", "weight": 0.96875}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "SNO", "q": 1, "question": "Will the filter supplier change?", "projects": {"Astro": {"answer": "Yes", "weight": 0.96875}, "Tango": {"answer": "Yes", "weight": 0.96875}}}, {"section": "SNO", "q": 2, "question": "Will there be a need to supply base rods from a different site?", "projects": {"Astro": {"answer": "Yes", "weight": 1.15625}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "SNO", "q": 3, "question": "Will the blend supplier change?", "projects": {"Astro": {"answer": "Yes", "weight": 0.96875}, "Tango": {"answer": "Yes", "weight": 0.96875}}}, {"section": "SNO", "q": 4, "question": "Will the source of blend ingredients change by this initiative (Diet, Fibex, Stem)?", "projects": {"Astro": {"answer": "Yes", "weight": 1.25}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "SNO", "q": 5, "question": "Will the initiative introduce a change in CSP?", "projects": {"Astro": {"answer": "Yes", "weight": 1.0625}, "Tango": {"answer": "Yes", "weight": 1.0625}}}, {"section": "SNO", "q": 6, "question": "Dependant on legal clearance?", "projects": {"Astro": {"answer": "Yes", "weight": 2.0}, "Tango": {"answer": "Yes", "weight": 2.0}}}, {"section": "SNO", "q": 7, "question": "Dependant on TradeMark clearance?", "projects": {"Astro": {"answer": "Yes", "weight": 2.0}, "Tango": {"answer": "Yes", "weight": 2.0}}}, {"section": "SNO", "q": 8, "question": "Any touchpoints with Sanctioned Countries?", "projects": {"Astro": {"answer": "No", "weight": 0.0}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "SNO", "q": 13, "question": "Will the initiative necessitate extended warehousing capacity and/or new warehouse or new capability either in the current warehouse or the extension/new location?", "projects": {"Astro": {"answer": "Yes", "weight": 1.90625}, "Tango": {"answer": "Yes", "weight": 1.90625}}}, {"section": "SNO", "q": 31, "question": "Will there be a negative impact on sustainability score?", "projects": {"Astro": {"answer": "No", "weight": 0.0}, "Tango": {"answer": "No", "weight": 0.0}}}, {"section": "SNO", "q": 33, "question": "Is the initiative outside of the annual OPS productivity cycle plan which has already been shared with other functions for resource planning purposes?", "projects": {"Astro": {"answer": "Yes", "weight": 0.875}, "Tango": {"answer": "Yes", "weight": 0.875}}}], "top5": [{"label": "SNO #6 — Dependant on legal clearance?", "yes_count": 2, "total_weight": 4.0}, {"label": "SNO #7 — Dependant on TradeMark clearance?", "yes_count": 2, "total_weight": 4.0}, {"label": "Factory #10 — Will the initiative trigger installation or modification of any machinery at the receiving factory?", "yes_count": 2, "total_weight": 3.81}, {"label": "SNO #13 — Will the initiative necessitate extended warehousing capacity and/or new warehouse or new capability either in the current warehouse or the extension/new location?", "yes_count": 2, "total_weight": 3.81}, {"label": "Factory #16 — Any factory trials, VAT, MQS for new suppliers, machinery, spec, profile at the receiving factory?", "yes_count": 2, "total_weight": 3.25}]};
  const STEP4_LIBRARY = [{"rank_sheet": 1, "area": "Legal", "q": 6, "question_ref": "Q6 – Legal clearance (e.g., CMAs)", "title": "Legal clearance (e.g., CMAs)", "bottleneck": "Gating dependency for both projects; potential delays in delivery.", "combined_weight_sheet": 4.0, "mitigation": "Joint legal resources with a unified tracker and escalation path covering the entire project portfolio."}, {"rank_sheet": 2, "area": "Trademark", "q": 7, "question_ref": "Q7 – TM clearance", "title": "TM clearance", "bottleneck": "Same critical‑path behavior as legal; brand/site moves require approvals before factory and system work can meaningfully start.", "combined_weight_sheet": 4.0, "mitigation": "Agreed SLA and unified tracker to feed into project timelines."}, {"rank_sheet": 3, "area": "Factory Enablement", "q": 10, "question_ref": "Q10 – Install/modify machinery", "title": "Install/modify machinery", "bottleneck": "Competes for engineering, OEM sources.", "combined_weight_sheet": 3.81, "mitigation": "Global calendar to align timing for shared resources"}, {"rank_sheet": 4, "area": "Warehousing", "q": 13, "question_ref": "Q13 – Extra WH capacity/capability", "title": "Extra WH capacity/capability", "bottleneck": "Parallel needs for capacity (space) and capability (e.g., T&T) at factory/central hubs.", "combined_weight_sheet": 3.81, "mitigation": "Global Logistics plan consolidation - involve global team at early stages of exploration"}, {"rank_sheet": 5, "area": "Trials & Qualification", "q": 16, "question_ref": "Q16 – Trials / VAT / MQS", "title": "Trials / VAT / MQS", "bottleneck": "Concurrent trials", "combined_weight_sheet": 3.25, "mitigation": "If competing for global involvement, apply global calendar practice."}, {"rank_sheet": 6, "area": "Inventory/BAU", "q": 12, "question_ref": "Q12 – BAU inventory level changes", "title": "BAU inventory level changes", "bottleneck": "Overall WC impact", "combined_weight_sheet": 2.13, "mitigation": "Financial impact presented at group level; not limited at entity level."}, {"rank_sheet": 7, "area": "CSP", "q": 5, "question_ref": "Q5 – CSP change", "title": "CSP change", "bottleneck": "Repetitive changes in the plans", "combined_weight_sheet": 2.13, "mitigation": "Updates restricted with regular review cycles (if project implementation timings approx. 8-12 months)"}, {"rank_sheet": 8, "area": "Filter Supply", "q": 1, "question_ref": "Q1 – Filter supplier change", "title": "Filter supplier change", "bottleneck": "Individiual capacity and capability checks at project level", "combined_weight_sheet": 1.94, "mitigation": "Only in-house supply. Sensitivities applied on RCCP"}];
</script>

<script>
(() => {
  // Shared helpers
  const clamp01 = (n) => Math.max(0, Math.min(1, Number(n) || 0));
  const fmt2 = (n) => (typeof n === 'number' && !Number.isNaN(n)) ? n.toFixed(2) : '–';
  const get = (obj, key) => (obj && Object.prototype.hasOwnProperty.call(obj, key)) ? obj[key] : undefined;

  // -------------------------------
  // Step #1
  // -------------------------------
  function polarToXY(cx, cy, r, angleRad){
    return [cx + r * Math.cos(angleRad), cy + r * Math.sin(angleRad)];
  }

  function drawRadar(rows){
    const svg = document.getElementById('radarSvg');
    svg.innerHTML = '';

    const size = 560;
    const cx = size / 2;
    const cy = size / 2;
    const maxR = 220;
    const N = rows.length;
    const ticks = [0.2, 0.4, 0.6, 0.8, 1.0];

    ticks.forEach(t => {
      const r = t * maxR;
      const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
      circle.setAttribute('cx', cx);
      circle.setAttribute('cy', cy);
      circle.setAttribute('r', r);
      circle.setAttribute('fill', 'none');
      circle.setAttribute('stroke', '#e3eaf3');
      circle.setAttribute('stroke-width', '1');
      svg.appendChild(circle);

      const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
      lbl.setAttribute('x', cx + 4);
      lbl.setAttribute('y', cy - r - 4);
      lbl.setAttribute('class','tick-label');
      lbl.textContent = t.toFixed(1);
      svg.appendChild(lbl);
    });

    rows.forEach((row, i) => {
      const angle = (Math.PI * 2 * i / N) - Math.PI / 2;
      const [x2, y2] = polarToXY(cx, cy, maxR, angle);

      const axis = document.createElementNS('http://www.w3.org/2000/svg','line');
      axis.setAttribute('x1', cx);
      axis.setAttribute('y1', cy);
      axis.setAttribute('x2', x2);
      axis.setAttribute('y2', y2);
      axis.setAttribute('stroke', '#d7e2ef');
      axis.setAttribute('stroke-width', '1');
      svg.appendChild(axis);

      const [lx, ly] = polarToXY(cx, cy, maxR + 22, angle);
      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x', lx);
      label.setAttribute('y', ly);
      label.setAttribute('text-anchor', Math.cos(angle) > 0.3 ? 'start' : (Math.cos(angle) < -0.3 ? 'end' : 'middle'));
      label.setAttribute('dominant-baseline', Math.sin(angle) > 0.3 ? 'hanging' : (Math.sin(angle) < -0.3 ? 'ideographic' : 'central'));
      label.setAttribute('class','axis-label');
      label.textContent = get(row,'Function') || '';
      svg.appendChild(label);
    });

    const pts = rows.map((row, i) => {
      const val = clamp01(get(row,'Impact_weights'));
      const angle = (Math.PI * 2 * i / N) - Math.PI / 2;
      return polarToXY(cx, cy, val * maxR, angle);
    });

    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    poly.setAttribute('points', pts.map(p => p.join(',')).join(' '));
    poly.setAttribute('fill', '#66A3D2');
    poly.setAttribute('opacity', '0.30');
    poly.setAttribute('stroke', '#0B6FB8');
    poly.setAttribute('stroke-width', '2');
    svg.appendChild(poly);

    const tooltip = document.getElementById('tooltip');
    rows.forEach((row, i) => {
      const val = clamp01(get(row,'Impact_weights'));
      const angle = (Math.PI * 2 * i / N) - Math.PI / 2;
      const [x, y] = polarToXY(cx, cy, val * maxR, angle);

      const dot = document.createElementNS('http://www.w3.org/2000/svg','circle');
      dot.setAttribute('cx', x);
      dot.setAttribute('cy', y);
      dot.setAttribute('r', 5);
      dot.setAttribute('fill', '#0B6FB8');
      dot.setAttribute('stroke', '#ffffff');
      dot.setAttribute('stroke-width', '1.5');
      dot.style.cursor = 'pointer';

      dot.addEventListener('mouseenter', () => {
        tooltip.style.opacity = 1;
        const name = get(row,'Function') || '';
        const score = Number(get(row,'Impact_weights') || 0).toFixed(2);
        const yes = Number(get(row,'#Yes') || 0);
        const no = Number(get(row,'#No') || 0);
        tooltip.innerHTML = `<b>${name}</b><br/>Weighted impact: <b>${score}</b><br/>Yes: ${yes} · No: ${no}`;
      });

      dot.addEventListener('mousemove', (e) => {
        const wrap = document.getElementById('radarWrap').getBoundingClientRect();
        tooltip.style.left = (e.clientX - wrap.left) + 'px';
        tooltip.style.top = (e.clientY - wrap.top) + 'px';
      });

      dot.addEventListener('mouseleave', () => { tooltip.style.opacity = 0; });
      svg.appendChild(dot);
    });
  }

  function renderStep1(project){
    const obj = DATA[project];
    const rows = (obj && obj.rows) ? obj.rows.slice() : [];

    const yes = rows.reduce((s,r) => s + (Number(get(r,'#Yes')) || 0), 0);
    const no = rows.reduce((s,r) => s + (Number(get(r,'#No')) || 0), 0);
    const sumResp = rows.reduce((s,r) => s + (Number(get(r,'Weighted_Responses')) || 0), 0);
    const sumBase = rows.reduce((s,r) => s + (Number(get(r,'Weighted_Base')) || 0), 0);
    const avg = sumBase ? (sumResp / sumBase) : 0;

    document.getElementById('kpiQ').textContent = String((window.STEP3 && window.STEP3.rows && window.STEP3.rows.length) ? window.STEP3.rows.length : 33);
    document.getElementById('kpiYes').textContent = String(yes);
    document.getElementById('kpiNo').textContent = String(no);
    document.getElementById('kpiAvg').textContent = avg.toFixed(2);

    const top = rows.slice().sort((a,b) => (Number(get(b,'Impact_weights')) || 0) - (Number(get(a,'Impact_weights')) || 0)).slice(0,3);
    const tb = document.querySelector('#topTbl tbody');
    tb.innerHTML = '';
    top.forEach(r => {
      const score = Number(get(r,'Impact_weights')) || 0;
      const pct = clamp01(score) * 100;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${get(r,'Function') || ''}</td>
        <td><div class="bar"><span style="width:${pct}%"></span></div></td>
        <td style="text-align:right;">${score.toFixed(2)}</td>
      `;
      tb.appendChild(tr);
    });

    const db = document.querySelector('#detailTbl tbody');
    db.innerHTML = '';
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${get(r,'Function') || ''}</td>
        <td>${Number(get(r,'#Yes') || 0)}</td>
        <td>${Number(get(r,'#No') || 0)}</td>
        <td>${Number(get(r,'Impact_count') || 0).toFixed(2)}</td>
        <td>${Number(get(r,'Impact_weights') || 0).toFixed(2)}</td>
      `;
      db.appendChild(tr);
    });

    drawRadar(rows);
  }

  const projectSel = document.getElementById('projectSel');
  projectSel.addEventListener('change', (e) => renderStep1(e.target.value));
  renderStep1(projectSel.value);

  // -------------------------------
  // Step #2
  // -------------------------------
  const PROJECTS = Object.keys(DATA);
  const FUNCTIONS = Array.from(new Set(PROJECTS.flatMap(p => (DATA[p] && DATA[p].rows ? DATA[p].rows : []).map(r => get(r,'Function'))))).filter(Boolean);

  const colorFor = (v) => {
    const pct = clamp01(v);
    const a = 0.12 + pct * 0.68;
    return `rgba(11,111,184,${a.toFixed(2)})`;
  };

  const getSelectedProjects = () => Array.from(document.querySelectorAll('.proj:checked')).map(x => x.value);

  function valueBy(project, func){
    const row = (DATA[project] && DATA[project].rows ? DATA[project].rows : []).find(r => get(r,'Function') === func);
    return row ? Number(get(row,'Impact_weights')) : null;
  }

  function baseBy(project, func){
    const row = (DATA[project] && DATA[project].rows ? DATA[project].rows : []).find(r => get(r,'Function') === func);
    return row ? Number(get(row,'Weighted_Base') || 0) : 0;
  }

  function aggregateWeighted(func, projs){
    const vals = projs.map(p => ({v:valueBy(p,func), w:baseBy(p,func)})).filter(x => x.v !== null);
    if (!vals.length) return null;
    const sumW = vals.reduce((s,x) => s + x.w, 0);
    if (sumW === 0) return vals.reduce((s,x) => s + x.v, 0) / vals.length;
    return vals.reduce((s,x) => s + x.v * x.w, 0) / sumW;
  }

  function renderStep2KPIs(projs){
    const sumResp = projs.reduce((s,p) => s + (DATA[p] && DATA[p].rows ? DATA[p].rows : []).reduce((ss,r) => ss + (Number(get(r,'Weighted_Responses')) || 0), 0), 0);
    const sumBase = projs.reduce((s,p) => s + (DATA[p] && DATA[p].rows ? DATA[p].rows : []).reduce((ss,r) => ss + (Number(get(r,'Weighted_Base')) || 0), 0), 0);
    const portfolio = sumBase ? (sumResp / sumBase) : 0;

    const ranges = [];
    FUNCTIONS.forEach(f => {
      const vs = projs.map(p => valueBy(p,f)).filter(v => v !== null);
      if (vs.length) ranges.push(Math.max(...vs) - Math.min(...vs));
    });
    const avgSpread = ranges.length ? ranges.reduce((s,x) => s + x, 0) / ranges.length : 0;

    const el = document.getElementById('kpiRow');
    el.innerHTML = `
      <div class="kpi"><div>Portfolio impact</div><div class="v">${fmt2(portfolio)}</div></div>
      <div class="kpi"><div>Average spread (project variability)</div><div class="v">${fmt2(avgSpread)}</div></div>
      <div class="kpi"><div>Functions covered</div><div class="v">${FUNCTIONS.length}</div></div>
    `;
  }

  function renderStep2Heat(projs){
    const tb = document.querySelector('#heatTbl tbody');
    tb.innerHTML = '';

    const rows = FUNCTIONS.map(f => {
      const rec = {Function:f, Aggregate: aggregateWeighted(f, projs)};
      PROJECTS.forEach(p => { rec[p] = valueBy(p,f); });
      return rec;
    }).filter(r => r.Aggregate !== null).sort((a,b) => b.Aggregate - a.Aggregate);

    rows.forEach(r => {
      const tr = document.createElement('tr');
      const td0 = document.createElement('td'); td0.textContent = r.Function; tr.appendChild(td0);
      const tdAgg = document.createElement('td'); tdAgg.textContent = fmt2(r.Aggregate); tdAgg.style.background = colorFor(r.Aggregate); tr.appendChild(tdAgg);
      PROJECTS.forEach(p => {
        const td = document.createElement('td'); td.textContent = fmt2(r[p]); td.style.background = colorFor(r[p]); tr.appendChild(td);
      });
      tb.appendChild(tr);
    });
  }

  function renderStep2Dumbbell(projs){
    const svg = document.getElementById('dbSvg');
    const W=760, H=420, L=130, R=30, T=24, B=34;
    svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
    svg.innerHTML = '';

    const innerW = W - L - R;
    const innerH = H - T - B;

    const items = FUNCTIONS.map(f => {
      const vals = projs.map(p => ({p, v:valueBy(p,f)})).filter(x => x.v !== null);
      if (!vals.length) return null;
      return {f, vals, agg: aggregateWeighted(f, projs)};
    }).filter(Boolean).sort((a,b) => b.agg - a.agg);

    const n = items.length;
    const rowH = innerH / Math.max(1, n);

    const xTicks = [0,0.2,0.4,0.6,0.8,1.0];
    xTicks.forEach(t => {
      const x = L + t * innerW;
      const grid = document.createElementNS('http://www.w3.org/2000/svg','line');
      grid.setAttribute('x1', x); grid.setAttribute('y1', T);
      grid.setAttribute('x2', x); grid.setAttribute('y2', H - B);
      grid.setAttribute('stroke', '#e6edf6'); grid.setAttribute('stroke-width', 1);
      svg.appendChild(grid);

      const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
      lbl.setAttribute('x', x); lbl.setAttribute('y', H - 8);
      lbl.setAttribute('text-anchor','middle'); lbl.setAttribute('fill','#5b6a7c');
      lbl.textContent = t.toFixed(1);
      svg.appendChild(lbl);
    });

    items.forEach((it,i) => {
      const cy = T + rowH * (i + 0.5);

      const lab = document.createElementNS('http://www.w3.org/2000/svg','text');
      lab.setAttribute('x', L - 8); lab.setAttribute('y', cy + 4);
      lab.setAttribute('text-anchor','end'); lab.setAttribute('fill','#003366');
      lab.textContent = it.f;
      svg.appendChild(lab);

      const vs = it.vals.map(o => o.v);
      const min = Math.min(...vs), max = Math.max(...vs);
      const x1 = L + min * innerW, x2 = L + max * innerW;

      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', x1); line.setAttribute('y1', cy);
      line.setAttribute('x2', x2); line.setAttribute('y2', cy);
      line.setAttribute('stroke', '#9fb8d3'); line.setAttribute('stroke-width', 3);
      svg.appendChild(line);

      it.vals.forEach(o => {
        const x = L + o.v * innerW;
        const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('cx', x); c.setAttribute('cy', cy); c.setAttribute('r', 6);
        c.setAttribute('fill', o.p === 'Astro' ? '#0B6FB8' : '#66A3D2');
        c.setAttribute('class','pt');
        svg.appendChild(c);
      });

      const ax = L + it.agg * innerW;
      const s = 7;
      const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
      poly.setAttribute('points', `${ax},${cy - s} ${ax + s},${cy} ${ax},${cy + s} ${ax - s},${cy}`);
      poly.setAttribute('fill','#003366'); poly.setAttribute('opacity','0.9');
      svg.appendChild(poly);
    });

    const legendY = 12;
    const baseX = L;
    const addLegend = (x, color, label) => {
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx', x); c.setAttribute('cy', legendY); c.setAttribute('r', 5); c.setAttribute('fill', color);
      svg.appendChild(c);
      const t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x', x + 10); t.setAttribute('y', legendY + 4);
      t.setAttribute('fill','#003366'); t.setAttribute('font-size','12');
      t.textContent = label;
      svg.appendChild(t);
    };
    addLegend(baseX, '#0B6FB8', 'Astro');
    addLegend(baseX + 90, '#66A3D2', 'Tango');

    const dx = baseX + 190;
    const s = 6;
    const d = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    d.setAttribute('points', `${dx},${legendY - s} ${dx + s},${legendY} ${dx},${legendY + s} ${dx - s},${legendY}`);
    d.setAttribute('fill','#003366');
    svg.appendChild(d);

    const t3 = document.createElementNS('http://www.w3.org/2000/svg','text');
    t3.setAttribute('x', dx + 10); t3.setAttribute('y', legendY + 4);
    t3.setAttribute('fill','#003366'); t3.setAttribute('font-size','12');
    t3.textContent = 'Average';
    svg.appendChild(t3);
  }

  function refreshStep2(){
    const projs = getSelectedProjects();
    renderStep2KPIs(projs);
    renderStep2Heat(projs);
    renderStep2Dumbbell(projs);
  }

  document.querySelectorAll('.proj').forEach(cb => cb.addEventListener('change', refreshStep2));
  refreshStep2();

  // -------------------------------
  // Step #3
  // -------------------------------
  const STEP3 = window.STEP3;
  const step3Projects = STEP3.projects || [];
  const step3Rows = STEP3.rows || [];

  const secs = Array.from(new Set(step3Rows.map(r => r.section))).filter(s => String(s).toLowerCase() !== 'cumulative').sort();
  const SECSEL = document.getElementById('secSel');
  SECSEL.innerHTML = secs.map(s => `<option value="${s}" selected>${s}</option>`).join('');

  const tbl = document.getElementById('step3Tbl');
  const thead = tbl.querySelector('thead');
  const tbody = tbl.querySelector('tbody');

  thead.innerHTML = `<tr><th style="width:140px">Section</th><th style="width:48px">#</th><th>Question</th>${step3Projects.map(p => `<th style="width:150px">${p}</th>`).join('')}</tr>`;

  const thrSel = document.getElementById('thrSel');
  const qSearch = document.getElementById('qSearch');

  function colorCell(ans, w, thr){
    if (String(ans).toLowerCase() !== 'yes') return '#FFFFFF';
    return (Number(w) >= thr) ? 'rgba(11,111,184,0.80)' : 'rgba(11,111,184,0.16)';
  }

  function renderTop5(){
    const wrap = document.getElementById('top5Bars');
    const list = STEP3.top5 || [];
    const maxScore = list.length ? Math.max(...list.map(t => (Number(t.yes_count) * 10 + Number(t.total_weight)))) : 0;

    wrap.innerHTML = '';
    list.forEach(t => {
      const score = (Number(t.yes_count) * 10 + Number(t.total_weight));
      const widthPct = maxScore > 0 ? Math.round((score / maxScore) * 100) : 0;
      const item = document.createElement('div');
      item.className = 'bar-item';
      item.innerHTML = `
        <div class="bar-label">${t.label}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${widthPct}%"></div></div>
        <div class="bar-stats">Yes in ${t.yes_count} project(s) · Weight ${Number(t.total_weight).toFixed(2)}</div>
      `;
      wrap.appendChild(item);
    });
  }

  function selectedSections(){
    return Array.from(SECSEL.selectedOptions).map(o => o.value);
  }

  function renderStep3(){
    const thr = parseFloat(thrSel.value);
    const sel = new Set(selectedSections());
    const q = String(qSearch.value || '').toLowerCase();

    tbody.innerHTML = '';

    step3Rows.forEach(r => {
      if (String(r.section).toLowerCase() === 'cumulative') return;
      if (sel.size && !sel.has(r.section)) return;
      if (q && !String(r.question).toLowerCase().includes(q)) return;

      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.section}</td><td>${r.q}</td><td>${r.question}</td>`;

      step3Projects.forEach(p => {
        const cell = (r.projects && r.projects[p]) ? r.projects[p] : {answer:'', weight:0};
        const bg = colorCell(cell.answer, cell.weight, thr);
        const td = document.createElement('td');
        const ans = cell.answer || '–';
        const w = Number(cell.weight) || 0;
        td.textContent = (String(ans).toLowerCase() === 'yes') ? `${ans} (${w.toFixed(2)})` : ans;
        td.style.background = bg;
        td.style.color = '#0b1f33';
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });
  }

  thrSel.addEventListener('change', renderStep3);
  SECSEL.addEventListener('change', renderStep3);
  qSearch.addEventListener('input', renderStep3);
  renderTop5();
  renderStep3();

  // -------------------------------
  // Step #4
  // -------------------------------
  const STATUS_LIST = ['Not started','In progress','Blocked','Done'];
  const LS_KEY = 'snd_step4_actions_v1';

  function loadActions(){
    try { return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); }
    catch(e){ return {}; }
  }
  function saveActions(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)); }
  function getKey(q){ return 'Q' + q; }

  const projWrap = document.getElementById('step4ProjCbs');
  const allProjects = (STEP3.projects || []).slice();
  projWrap.innerHTML = allProjects.map(p => `<label style="margin-right:10px"><input type="checkbox" class="step4Proj" value="${p}" checked> ${p}</label>`).join('');

  function selectedProjects(){
    const picked = Array.from(document.querySelectorAll('.step4Proj:checked')).map(x => x.value);
    return picked.length ? picked : allProjects.slice();
  }

  function findStep3Row(q){
    return step3Rows.find(r => Number(r.q) === Number(q));
  }

  function scoreForQ(q, projs){
    const row = findStep3Row(q);
    if (!row) return {score:0, hits:0};

    let score = 0, hits = 0;
    projs.forEach(p => {
      const cell = (row.projects && row.projects[p]) ? row.projects[p] : {answer:'', weight:0};
      if (String(cell.answer).toLowerCase() === 'yes'){
        score += Number(cell.weight) || 0;
        hits += 1;
      }
    });
    return {score, hits};
  }

  function drillToStep3(q){
    const rows = Array.from(tbl.querySelectorAll('tbody tr'));
    const match = rows.find(tr => {
      const tds = tr.querySelectorAll('td');
      return tds && tds.length >= 2 && Number(tds[1].textContent) === Number(q);
    });

    if (match){
      rows.forEach(r => r.classList.remove('hlRow'));
      match.classList.add('hlRow');
      match.scrollIntoView({behavior:'smooth', block:'center'});
      setTimeout(() => match.classList.remove('hlRow'), 2500);
    }
  }

  const sharedOnly = document.getElementById('sharedOnly');
  const searchBox = document.getElementById('step4Search');
  const kpiWrap = document.getElementById('step4Kpis');
  const step4Tbl = document.getElementById('step4Tbl');
  const actions = loadActions();

  function renderStep4(){
    const projs = selectedProjects();
    const mustShared = sharedOnly.checked;
    const q = String(searchBox.value || '').toLowerCase();

    const computed = STEP4_LIBRARY.map(item => {
      const sc = scoreForQ(item.q, projs);
      const key = getKey(item.q);
      const act = actions[key] || {};

      return {
        ...item,
        score: sc.score,
        hits: sc.hits,
        action: {
          owner: act.owner || '',
          status: act.status || 'Not started',
          due: act.due || '',
          mitigation: (act.mitigation !== undefined) ? act.mitigation : (item.mitigation || '')
        }
      };
    });

    const filtered = computed
      .filter(x => !mustShared || x.hits >= 2)
      .filter(x => {
        if (!q) return true;
        const blob = [
          x.area, x.question_ref, x.title, x.bottleneck, x.mitigation,
          x.action.mitigation, x.action.owner, x.action.status, x.action.due
        ].join(' ').toLowerCase();
        return blob.includes(q);
      })
      .sort((a,b) => (b.score - a.score) || (b.hits - a.hits));

    kpiWrap.innerHTML = `<div class="kpi"><div>Bottlenecks shown</div><div class="v">${filtered.length}</div></div>`;

    step4Tbl.querySelector('thead').innerHTML = `
      <tr>
        <th style="width:60px">Rank</th>
        <th style="width:170px">Area</th>
        <th style="width:70px">Q#</th>
        <th style="min-width:420px">Bottleneck</th>
        <th style="width:220px">Mitigation (editable)</th>
        <th style="width:140px">Owner</th>
        <th style="width:140px">Status</th>
        <th style="width:140px">Due date</th>
        <th style="width:120px">Drill</th>
      </tr>
    `;

    const tbody4 = step4Tbl.querySelector('tbody');
    tbody4.innerHTML = '';

    filtered.forEach((x, idx) => {
      const key = getKey(x.q);
      const statusOptions = STATUS_LIST.map(s => `<option ${x.action.status === s ? 'selected' : ''}>${s}</option>`).join('');

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${x.area}</td>
        <td>Q${x.q}</td>
        <td>${x.bottleneck}</td>
        <td><textarea class="inpCell" data-k="${key}" data-f="mitigation" rows="3">${x.action.mitigation}</textarea></td>
        <td><input class="inpCell" data-k="${key}" data-f="owner" value="${x.action.owner}"></td>
        <td><select class="selCell" data-k="${key}" data-f="status">${statusOptions}</select></td>
        <td><input class="inpCell" type="date" data-k="${key}" data-f="due" value="${x.action.due}"></td>
        <td><button class="btnLink" data-drill="${x.q}">Step #3</button></td>
      `;
      tbody4.appendChild(tr);
    });

    tbody4.querySelectorAll('button[data-drill]').forEach(btn => {
      btn.addEventListener('click', () => drillToStep3(Number(btn.getAttribute('data-drill'))));
    });

    tbody4.querySelectorAll('[data-k][data-f]').forEach(el => {
      const handler = () => {
        const k = el.getAttribute('data-k');
        const f = el.getAttribute('data-f');
        actions[k] = actions[k] || {};
        actions[k][f] = el.value;
        saveActions(actions);
      };
      el.addEventListener('input', handler);
      el.addEventListener('change', handler);
    });
  }

  document.querySelectorAll('.step4Proj').forEach(cb => cb.addEventListener('change', renderStep4));
  sharedOnly.addEventListener('change', renderStep4);
  searchBox.addEventListener('input', renderStep4);
  renderStep4();
})();
</script>

</body>
</html>
